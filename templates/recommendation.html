{% extends "base.html" %}

{% block title %}{{ recommendation.title }} - {{ category.name }} - {{ profile.name }} - CUR8tr{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/recommendation-page-clean.css') }}">
<style>
.main-header {
    background: #B3E0DD !important;
}
</style>
{% endblock %}

{% block content %}
    <!-- Main Recommendation Card -->
    <div class="frame8-recommendation-window">
        <div class="frame8-recommendation-window-title">YOUR RECOMMENDATION</div>
        <div class="frame8-recommendation-content">
            {% if recommendation.image %}
                <img src="{{ recommendation.image }}" alt="{{ recommendation.title }}" class="frame8-recommendation-image">
            {% endif %}
            <div class="frame8-recommendation-details">
                <!-- First row: Category name (left) and Rating (right) -->
                <div class="frame8-recommendation-meta-row">
                    <span class="frame8-recommendation-category">
                        <i class="fas fa-folder"></i> {{ category.name }}
                    </span>
                    {% if recommendation.rating %}
                        <span class="frame8-recommendation-rating">
                            {% for i in range(recommendation.rating) %}üëç{% endfor %}
                        </span>
                    {% endif %}
                </div>
                
                <!-- Second row: Title (left) and Cost Rating (right) -->
                <div class="frame8-recommendation-title-row">
                    <span class="frame8-recommendation-title">{{ recommendation.title }}</span>
                    {% if recommendation.cost_rating %}
                        <span class="frame8-recommendation-cost">
                            <img src="{{ url_for('static', filename='svg/dollar-circle.svg') }}" alt="Cost" style="width: 18px; height: 18px;"> {% if recommendation.cost_rating == '$' %}Budget Friendly
                            {% elif recommendation.cost_rating == '$$' %}Moderate
                            {% elif recommendation.cost_rating == '$$$' %}Expensive
                            {% elif recommendation.cost_rating == '$$$$' %}Premium/Luxury
                            {% else %}Budget Friendly
                            {% endif %}
                        </span>
                    {% endif %}
                </div>
                
                <div class="frame8-recommendation-description">
                    {{ recommendation.description }}
                </div>
                {% if recommendation.pro_tip %}
                    <div class="frame8-recommendation-protip">
                        <div class="frame8-tip-icon-container">
                            <img src="{{ url_for('static', filename='svg/bulb.svg') }}" alt="Pro Tip" style="width: 24px; height: 24px;">
                        </div>
                        <span class="frame8-recommendation-protip-label">Pro Tip:</span>
                        <span>{{ recommendation.pro_tip }}</span>
                    </div>
                {% endif %}

                <!-- Action Buttons for Visit Link and Maps - Right after Pro Tip -->
                <div class="frame8-recommendation-actions-top">
                    {% if recommendation.url %}
                        <a href="{{ recommendation.url }}" target="_blank" rel="noopener" class="frame8-btn-primary">
                            <img src="{{ url_for('static', filename='svg/globe-earth.svg') }}" alt="Visit" style="width: 18px; height: 18px;"> Visit Link
                        </a>
                    {% endif %}
                    {% if recommendation.location %}
                        <a href="{{ recommendation.get_google_maps_link() }}" target="_blank" rel="noopener" class="frame8-btn-primary">
                            <img src="{{ url_for('static', filename='svg/map-location.svg') }}" alt="Maps" style="width: 18px; height: 18px;"> View on Google Maps
                        </a>
                    {% endif %}
                </div>

                {% if recommendation.safe_tags.get('categories') or recommendation.safe_tags.get('collections') %}
                    <div class="frame8-recommendation-tags">
                        {% for tag in recommendation.safe_tags.get('categories', []) %}
                            <span class="frame8-tag-category">{{ tag }}</span>
                        {% endfor %}
                        {% for tag in recommendation.safe_tags.get('collections', []) %}
                            <span class="frame8-tag-collection">{{ tag }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Likes List -->
        {% if recommendation.likes %}
            <div style="margin-top: 12px;">
                <span class="frame8-liked-by-label">
                    <img src="{{ url_for('static', filename='svg/heart.svg') }}" alt="Liked" class="frame8-liked-by-svg">
                    Liked by:
                </span>
                <div style="margin-top: 6px; display: flex; gap: 8px; flex-wrap: wrap;">
                    {% for like in recommendation.likes %}
                        <span style="background: #B5B0D8; color: #000; padding: 2px 6px; font-size: 10px; border-radius: 3px; display: inline-flex; align-items: center; gap: 4px;">
                            <i class="fas fa-user" style="font-size: 8px;"></i>
                            {{ like.user.profile.name if like.user.profile else like.user.username }}
                        </span>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!-- Comments Section with Social Actions -->
        <div class="frame8-comments-header">
            <h3 class="frame8-comments-title">Comments ({{ recommendation.comments|length }})</h3>
            <div class="frame8-recommendation-actions">
                <form id="like-form" method="POST" action="{{ url_for('like_recommendation', profile_slug=profile.slug, category_slug=category.slug, rec_id=recommendation.id) }}">
                    <button type="submit" id="like-button" class="frame8-btn-like {% if recommendation.is_liked_by(current_user) %}liked{% endif %}">
                        <img src="{{ url_for('static', filename='svg/heart.svg') }}" alt="Like" style="width: 18px; height: 18px;">
                        <span id="like-count">{{ recommendation.get_like_count() }}</span> Likes
                    </button>
                </form>
                <button onclick="shareRecommendation('{{ recommendation.title }}', '{{ url_for('view_recommendation', profile_slug=profile.slug, category_slug=category.slug, rec_id=recommendation.id, _external=True) }}')" class="frame8-btn-share">
                    <img src="{{ url_for('static', filename='svg/arrow_right.svg') }}" alt="Share" style="width: 18px; height: 18px;"> Share
                </button>
            </div>
        </div>
        
        <div class="frame8-recommendation-comments">
            {% if current_user %}
                <form method="POST" class="frame8-comment-form">
                    {{ comment_form.hidden_tag() }}
                    {{ comment_form.content(class="frame8-comment-input", placeholder="Add a comment...") }}
                    {% if comment_form.content.errors %}
                        <div style="color: red; font-size: 12px; margin-top: 4px;">
                            {% for error in comment_form.content.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                    <button type="submit" class="frame8-comment-submit">
                        <img src="{{ url_for('static', filename='svg/check.svg') }}" alt="Post" style="width: 18px; height: 18px;"> Post Comment
                    </button>
                </form>
            {% else %}
                <div class="frame8-comment-login-prompt">
                    <a href="{{ url_for('login') }}" class="frame8-btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Login to Comment
                    </a>
                </div>
            {% endif %}
            {% if recommendation.comments %}
                <div class="frame8-comments-list">
                    {% for comment in recommendation.comments %}
                        <div class="frame8-comment-card">
                            <div class="frame8-comment-header">
                                <span><i class="fas fa-user"></i> {{ comment.user.profile.name if comment.user.profile else comment.user.username }}</span>
                                <span class="frame8-comment-date">{{ comment.created_at.strftime('%b %d, %Y %I:%M %p') }}</span>
                                {% if current_user and (comment.user_id == current_user.id or recommendation.category.profile.user_id == current_user.id) %}
                                    <form method="POST" action="{{ url_for('delete_comment', profile_slug=profile.slug, category_slug=category.slug, rec_id=recommendation.id, comment_id=comment.id) }}" style="display: inline;">
                                        <button type="submit" class="frame8-btn-delete"><i class="fas fa-trash"></i></button>
                                    </form>
                                {% endif %}
                            </div>
                            <div class="frame8-comment-body">
                                <p>{{ comment.content }}</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="frame8-no-comments">
                    No Comments Yet. Be The First!
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="frame8-bottom-nav">
        <a href="{{ url_for('view_category', profile_slug=profile.slug, category_slug=category.slug) }}" class="frame8-nav-back">
            <span>‚Üê</span> Back to {{ category.name }}
        </a>
        <div class="frame8-nav-date">
            Added {{ recommendation.created_at.strftime('%b %d, %Y @ %I:%M %p') }}
        </div>
        <a href="{{ url_for('view_profile', slug=profile.slug) }}" class="frame8-nav-profile">
            <span>üë§</span> {{ profile.name }}'s Profile
        </a>
    </div>
    </div>
<!-- </div> -->

<script>
document.addEventListener('DOMContentLoaded', function() {
    const likeForm = document.getElementById('like-form');
    const likeButton = document.getElementById('like-button');
    const likeCount = document.getElementById('like-count');
    
    if (likeForm && likeButton) {
        likeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Disable button during request
            likeButton.disabled = true;
            
            fetch(likeForm.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update like count
                    likeCount.textContent = data.like_count;
                    
                    // Update button appearance and text
                    if (data.is_liked) {
                        likeButton.style.background = 'var(--primary-pink)';
                        likeButton.style.color = 'white';
                        likeButton.style.borderColor = 'var(--primary-pink)';
                        likeButton.innerHTML = '<i class="fas fa-heart"></i> Unlike';
                    } else {
                        likeButton.style.background = 'var(--gray-100)';
                        likeButton.style.color = 'var(--text-secondary)';
                        likeButton.style.borderColor = 'var(--gray-200)';
                        likeButton.innerHTML = '<i class="fas fa-heart"></i> Like';
                    }
                    
                    // Reload page to update "Liked by" section
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Fallback to regular form submission
                likeForm.submit();
            })
            .finally(() => {
                likeButton.disabled = false;
            });
        });
    }
});
</script>
{% endblock %}