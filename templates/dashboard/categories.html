{% extends "base.html" %}

{% block title %}Categories - Dashboard - CUR8tr{% endblock %}

{% block styles %}
<style>
  body {
    background: #FDD4A4 !important; /* Use !important to ensure override */
  }
</style>
{% endblock %}

{% block body_class %}categories-bg{% endblock %}

{% block content %}
<section class="categories-dashboard">
  <div class="categories-header-row">
    <div class="categories-title">MANAGE CATEGORIES</div>
    <button type="button" class="categories-add-btn">
      <img src="{{ url_for('static', filename='svg/plus-circle.svg') }}" alt="Add" class="categories-add-icon">
      <span>Add Custom Category</span>
    </button>
  </div>
  {% set icon_map = {
    "Books": "book-text.svg",
    "Food": "food-tray.svg",
    "Youtube Channels": "youtube.svg",
    "Apps": "mobile.svg",
    "Products": "box.svg",
    "Where to Stay": "location-pin.svg"
  } %}

  <!-- Categories Grid -->
<div class="categories-grid">
  {% for category in categories[:20] %}
    {% set icon_file = icon_map.get(category.name, "default.svg") %}
    <div class="category-card">
      <div class="category-card-header">
        <div class="category-card-title-row">
          <span class="category-card-icon">
            <img src="{{ url_for('static', filename='svg/' ~ icon_file) }}" alt="{{ category.name }}">
          </span>
          <span class="category-card-title">{{ category.name }}</span>
        </div>
        <span class="category-card-count">{{ category.count or 0 }}</span>
      </div>
      <div class="category-card-description">
        {{ category.description }}
      </div>
      <div class="category-card-actions">
      <button type="button" class="category-action-btn add" 
              onclick="window.location.href='{{ url_for('dashboard_recommendations', category_id=category.id) }}'">
        <img src="{{ url_for('static', filename='svg/plus-circle.svg') }}" alt="Add">
        <span>Add Item</span>
      </button>

      <button type="button" class="category-action-btn view" 
              onclick="window.open('{{ url_for('view_category', profile_slug=profile.slug, category_slug=category.slug) }}', '_blank')">
        <img src="{{ url_for('static', filename='svg/eye.svg') }}" alt="View">
        <span>View</span>
      </button>
      </div>
    </div>
  {% endfor %}
</div>

</section>

<!-- Modal Overlay and Popup -->
<div id="category-modal-overlay" style="display:none;"></div>
<div id="category-modal" style="display:none;">
  <div id="category-modal-loader" class="loader"></div>
  <div id="category-modal-content" style="display:none;"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Open modal and fetch form via AJAX
  document.querySelector('.categories-add-btn').addEventListener('click', function(e) {
    e.preventDefault();
    document.getElementById('category-modal-overlay').style.display = 'block';
    document.getElementById('category-modal').style.display = 'block';
    document.getElementById('category-modal-loader').style.display = 'block';
    document.getElementById('category-modal-content').style.display = 'none';
    document.body.classList.add('modal-open');
    // Fetch form HTML
    fetch('/dashboard/categories/form')
      .then(response => response.text())
      .then(html => {
        document.getElementById('category-modal-loader').style.display = 'none';
        document.getElementById('category-modal-content').innerHTML = html;
        document.getElementById('category-modal-content').style.display = 'block';
        
        // Attach form submission handler
        const form = document.querySelector('#category-modal-content form');
        if (form) {
          form.addEventListener('submit', handleCategoryFormSubmit);
        }
      });
  });

  // Handle category form submission via AJAX
  function handleCategoryFormSubmit(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    
    fetch(form.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Show success message
        showFlashMessage(data.message, 'success');
        // Close modal
        closeModal();
        // Reload categories
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      } else {
        // Show error message
        showFlashMessage(data.message, 'warning');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showFlashMessage('An error occurred while creating the category.', 'danger');
    });
  }

  // Helper function to close modal
  function closeModal() {
    document.getElementById('category-modal-overlay').style.display = 'none';
    document.getElementById('category-modal').style.display = 'none';
    document.body.classList.remove('modal-open');
  }

  // Helper function to show flash message
  function showFlashMessage(message, type) {
    // Create a temporary flash message element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    
    // Determine color based on type
    let bgColor;
    if (type === 'success') {
      bgColor = '#28a745'; // Green
    } else if (type === 'warning') {
      bgColor = '#dc3545'; // Red for warnings
    } else {
      bgColor = '#dc3545'; // Red for danger/errors
    }
    
    alertDiv.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      background-color: ${bgColor};
      color: white;
      border-radius: 4px;
      z-index: 9999;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      animation: slideIn 0.3s ease-in-out;
    `;
    
    document.body.appendChild(alertDiv);
    
    // Remove after 3 seconds
    setTimeout(() => {
      alertDiv.style.animation = 'slideOut 0.3s ease-in-out';
      setTimeout(() => {
        alertDiv.remove();
      }, 300);
    }, 3000);
  }

  // Close modal when overlay is clicked
  document.getElementById('category-modal-overlay').addEventListener('click', function() {
    const modal = document.getElementById('category-modal');
    if (event.target === this) {
      modal.style.display = 'none';
      document.getElementById('category-modal-overlay').style.display = 'none';
      document.body.classList.remove('modal-open');
    }
  });
});
</script>
{% endblock %}
