{% extends "base.html" %}

{% block title %}{{ recommendation.title }} - {{ category.name }} - {{ profile.name }} - CUR8tr{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div style="margin: 16px 0; font-size: 11px;">
    <a href="{{ url_for('view_profile', slug=profile.slug) }}" style="color: var(--primary-cyan);">
        <i class="fas fa-user"></i> {{ profile.name }}
    </a>
    <span style="color: var(--text-secondary);"> > </span>
    <a href="{{ url_for('view_category', profile_slug=profile.slug, category_slug=category.slug) }}" style="color: var(--primary-cyan);">
        {{ category.name }}
    </a>
    <span style="color: var(--text-secondary);"> > </span>
    <span>{{ recommendation.title }}</span>
</div>

<!-- Recommendation Details -->
<div class="window">
    <div class="window-header">
        <span><i class="icon icon-star"></i> {{ recommendation.title }}</span>
        <div class="window-controls">
            <div class="window-button">_</div>
            <div class="window-button">‚ñ°</div>
            <div class="window-button">√ó</div>
        </div>
    </div>
    <div class="window-content">
        <!-- Image and Main Info -->
        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
            {% if recommendation.image %}
                <div style="flex-shrink: 0;">
                    <img src="{{ recommendation.image }}" alt="{{ recommendation.title }}" style="
                        width: 200px; 
                        height: 200px; 
                        border-radius: 12px; 
                        object-fit: cover;
                        border: 2px solid var(--gray-200);
                    ">
                </div>
            {% endif %}
            
            <div style="flex-grow: 1;">
                <h1 style="font-size: 18px; font-weight: bold; margin-bottom: 12px;">{{ recommendation.title }}</h1>
                
                <!-- Rating and Cost -->
                <div style="display: flex; gap: 20px; margin-bottom: 16px;">
                    {% if recommendation.rating %}
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: bold; font-size: 12px;">Rating:</span>
                            <div style="font-size: 14px;">
                                {% for i in range(recommendation.rating) %}üëç{% endfor %}
                                <span style="color: var(--text-secondary); margin-left: 8px;">
                                    ({{ recommendation.rating }}/5)
                                </span>
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if recommendation.cost_rating %}
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: bold; font-size: 12px;">Cost:</span>
                            <div style="font-size: 14px; color: var(--primary-green);">
                                {{ recommendation.cost_rating }}
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Category -->
                <div style="margin-bottom: 16px;">
                    <span style="font-weight: bold; font-size: 12px;">Category:</span>
                    <a href="{{ url_for('view_category', profile_slug=profile.slug, category_slug=category.slug) }}" 
                       style="color: var(--primary-purple); text-decoration: none; margin-left: 8px;">
                        {{ category.name }}
                    </a>
                </div>
                
                <!-- Description -->
                {% if recommendation.description %}
                    <div style="margin-bottom: 16px;">
                        <span style="font-weight: bold; font-size: 12px;">Description:</span>
                        <p style="margin-top: 8px; line-height: 1.5;">{{ recommendation.description }}</p>
                    </div>
                {% endif %}

                <!-- Pro Tip -->
                {% if recommendation.pro_tip %}
                    <div style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, #fff4e6 0%, #ffe8cc 100%); border-radius: 8px; border-left: 4px solid var(--primary-orange);">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 16px; margin-right: 6px;">üí°</span>
                            <span style="font-weight: bold; font-size: 12px; color: var(--primary-orange);">Pro Tip:</span>
                        </div>
                        <p style="margin: 0; line-height: 1.5; font-style: italic; color: #8b4513;">{{ recommendation.pro_tip }}</p>
                    </div>
                {% endif %}
                
                <!-- URL -->
                {% if recommendation.url %}
                    <div style="margin-bottom: 16px;">
                        <span style="font-weight: bold; font-size: 12px;">Link:</span>
                        <div style="margin-top: 8px;">
                            <a href="{{ recommendation.url }}" target="_blank" rel="noopener" class="btn btn-primary">
                                <i class="icon icon-link"></i> Visit Link
                            </a>
                        </div>
                        <div style="margin-top: 4px; font-size: 10px; color: var(--text-secondary); word-break: break-all;">
                            {{ recommendation.url }}
                        </div>
                    </div>
                {% endif %}
                
                <!-- Location -->
                {% if recommendation.location %}
                    <div style="margin-bottom: 16px;">
                        <span style="font-weight: bold; font-size: 12px;">Location:</span>
                        <div style="margin-top: 8px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                            <span style="color: var(--text-secondary); font-size: 14px;">{{ recommendation.location }}</span>
                            <a href="{{ recommendation.get_google_maps_link() }}" target="_blank" rel="noopener" class="btn" 
                               style="background: var(--soft-green); font-size: 12px; padding: 6px 12px;">
                                <i class="fas fa-map-marker-alt"></i> View on Google Maps
                            </a>
                        </div>
                    </div>
                {% endif %}

                <!-- Tags Display -->
                {% if recommendation.tags %}
                    <div style="margin-bottom: 16px;">
                        <span style="font-weight: bold; font-size: 12px;">Tags:</span>
                        <div style="margin-top: 8px;">
                            {% if recommendation.tags.get('categories') %}
                                <div style="margin-bottom: 6px;">
                                    <span style="font-size: 11px; color: var(--text-secondary); margin-right: 6px;">Categories:</span>
                                    {% for tag in recommendation.tags['categories'] %}
                                        <span style="display: inline-block; margin: 2px; padding: 3px 8px; background: #e0f2fe; color: #0277bd; border-radius: 12px; font-size: 11px;">{{ tag }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            {% if recommendation.tags.get('collections') %}
                                <div>
                                    <span style="font-size: 11px; color: var(--text-secondary); margin-right: 6px;">Collections:</span>
                                    {% for tag in recommendation.tags['collections'] %}
                                        <span style="display: inline-block; margin: 2px; padding: 3px 8px; background: #e8f5e8; color: #2e7d32; border-radius: 12px; font-size: 11px;">{{ tag }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
                
                <!-- Mac OS Style Management Window for Recommendation Owner -->
                {% if current_user and recommendation.category.profile.user_id == current_user.id %}
                    <div class="window" style="margin-bottom: 20px; background: linear-gradient(135deg, #FFB6C1, #DDA0DD); border: 2px solid #888;">
                        <div class="window-header" style="background: linear-gradient(135deg, #FFB6C1, #DDA0DD); border-bottom: 1px solid #888; font-weight: bold;">
                            <span style="color: #333; font-size: 13px;">
                                <i class="fas fa-cog"></i> Manage Recommendation
                            </span>
                            <div class="window-controls">
                                <div class="window-button close"></div>
                                <div class="window-button minimize"></div>
                                <div class="window-button maximize"></div>
                            </div>
                        </div>
                        <div class="window-content" style="padding: 16px; background: #F0F0F0;">
                            <p style="margin: 0 0 12px 0; font-size: 12px; color: #555;">
                                You own this recommendation. You can edit its details or remove it from your profile.
                            </p>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <a href="{{ url_for('edit_recommendation', rec_id=recommendation.id) }}" 
                                   class="btn" 
                                   style="
                                       background: linear-gradient(135deg, #98FB98, #90EE90); 
                                       border: 1px solid #666; 
                                       color: #333; 
                                       font-size: 12px; 
                                       padding: 8px 16px;
                                       box-shadow: inset 1px 1px 0 rgba(255,255,255,0.5), inset -1px -1px 0 rgba(0,0,0,0.25);
                                   ">
                                    <i class="fas fa-edit"></i> Edit Recommendation
                                </a>
                                <form method="POST" action="{{ url_for('delete_recommendation', rec_id=recommendation.id) }}" 
                                      style="display: inline;" 
                                      onsubmit="return confirm('Are you sure you want to delete this recommendation? This action cannot be undone.')">
                                    <button type="submit" 
                                            class="btn" 
                                            style="
                                                background: linear-gradient(135deg, #FFB6C1, #FF69B4); 
                                                border: 1px solid #666; 
                                                color: #333; 
                                                font-size: 12px; 
                                                padding: 8px 16px;
                                                box-shadow: inset 1px 1px 0 rgba(255,255,255,0.5), inset -1px -1px 0 rgba(0,0,0,0.25);
                                            ">
                                        <i class="fas fa-trash"></i> Delete Recommendation
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                {% endif %}
                
                <!-- Likes -->
                <div style="margin-bottom: 16px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
                    <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: bold; font-size: 12px;">Likes:</span>
                            <span id="like-count" style="color: var(--text-secondary); font-size: 14px;">{{ recommendation.get_like_count() }}</span>
                        </div>
                        
                        {% if current_user %}
                            <form id="like-form" method="POST" action="{{ url_for('like_recommendation', profile_slug=profile.slug, category_slug=category.slug, rec_id=recommendation.id) }}" style="display: inline;">
                                <button type="submit" id="like-button" class="btn" style="
                                    background: {% if recommendation.is_liked_by(current_user) %}var(--primary-pink){% else %}var(--gray-100){% endif %};
                                    color: {% if recommendation.is_liked_by(current_user) %}white{% else %}var(--text-secondary){% endif %};
                                    font-size: 12px; 
                                    padding: 6px 12px;
                                    border: 1px solid {% if recommendation.is_liked_by(current_user) %}var(--primary-pink){% else %}var(--gray-200){% endif %};
                                    transition: all 0.2s ease;
                                ">
                                    <i class="fas fa-heart"></i> 
                                    {% if recommendation.is_liked_by(current_user) %}Unlike{% else %}Like{% endif %}
                                </button>
                            </form>
                        {% else %}
                            <a href="{{ url_for('login') }}" class="btn" style="background: var(--gray-100); color: var(--text-secondary); font-size: 12px; padding: 6px 12px;">
                                <i class="fas fa-heart"></i> Login to Like
                            </a>
                        {% endif %}
                        
                        <!-- Enhanced Share Buttons -->
                        <div style="margin-left: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <!-- Main Share Button -->
                            <button onclick="shareRecommendation('{{ recommendation.title }}', '{{ url_for('view_recommendation', profile_slug=profile.slug, category_slug=category.slug, rec_id=recommendation.id, _external=True) }}')" class="btn" style="
                                background: linear-gradient(135deg, #9acd32, #7ba82c);
                                color: #000;
                                font-size: 12px; 
                                padding: 6px 12px;
                                border: 1px solid #7aa22e;
                                transition: all 0.2s ease;
                                border-radius: 6px;
                                font-weight: 500;
                            ">
                                <i class="fas fa-share" style="color: #000;"></i> Share
                            </button>
                            
                            <!-- Quick Share Buttons for Popular Platforms -->
                            <button onclick="quickShareWhatsApp('{{ recommendation.title }}', '{{ url_for('view_recommendation', profile_slug=profile.slug, category_slug=category.slug, rec_id=recommendation.id, _external=True) }}')" 
                                   class="btn" title="Share on WhatsApp" style="
                                background: #25D366;
                                color: white;
                                font-size: 11px; 
                                padding: 6px 8px;
                                border: 1px solid #25D366;
                                transition: all 0.2s ease;
                                border-radius: 6px;
                            ">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                            
                            <button onclick="quickShareTwitter('{{ recommendation.title }}', '{{ url_for('view_recommendation', profile_slug=profile.slug, category_slug=category.slug, rec_id=recommendation.id, _external=True) }}')" 
                                   class="btn" title="Share on Twitter" style="
                                background: #1DA1F2;
                                color: white;
                                font-size: 11px; 
                                padding: 6px 8px;
                                border: 1px solid #1DA1F2;
                                transition: all 0.2s ease;
                                border-radius: 6px;
                            ">
                                <i class="fab fa-twitter"></i>
                            </button>
                            
                            <button onclick="quickShareLinkedIn('{{ recommendation.title }}', '{{ url_for('view_recommendation', profile_slug=profile.slug, category_slug=category.slug, rec_id=recommendation.id, _external=True) }}')" 
                                   class="btn" title="Share on LinkedIn" style="
                                background: #0077B5;
                                color: white;
                                font-size: 11px; 
                                padding: 6px 8px;
                                border: 1px solid #0077B5;
                                transition: all 0.2s ease;
                                border-radius: 6px;
                            ">
                                <i class="fab fa-linkedin"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Show who liked this -->
                    {% if recommendation.likes %}
                        <div style="margin-top: 12px;">
                            <span style="font-weight: bold; font-size: 11px; color: var(--text-secondary);">Liked by:</span>
                            <div style="margin-top: 6px; display: flex; gap: 8px; flex-wrap: wrap;">
                                {% for like in recommendation.likes %}
                                    <span style="
                                        background: var(--soft-purple); 
                                        color: var(--text-dark); 
                                        padding: 2px 6px; 
                                        font-size: 10px; 
                                        border-radius: 3px;
                                        display: inline-flex;
                                        align-items: center;
                                        gap: 4px;
                                    ">
                                        <i class="fas fa-user" style="font-size: 8px;"></i>
                                        {{ like.user.profile.name if like.user.profile else like.user.username }}
                                    </span>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Comments Section -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--gray-200);">
                    <h3 style="font-size: 16px; margin-bottom: 16px; color: var(--text-primary);">
                        <i class="fas fa-comments"></i> Comments ({{ recommendation.comments|length }})
                    </h3>
                    
                    <!-- Add Comment Form -->
                    {% if current_user %}
                        <div style="margin-bottom: 20px; padding: 16px; background: var(--soft-purple); border-radius: 8px;">
                            <form method="POST">
                                {{ comment_form.hidden_tag() }}
                                <div style="margin-bottom: 12px;">
                                    <label style="font-weight: bold; font-size: 12px; margin-bottom: 6px; display: block;">Add a comment:</label>
                                    {{ comment_form.content(class="form-control", style="min-height: 80px; resize: vertical;") }}
                                    {% if comment_form.content.errors %}
                                        <div style="color: red; font-size: 10px; margin-top: 4px;">
                                            {% for error in comment_form.content.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <button type="submit" class="btn btn-primary" style="font-size: 12px; padding: 8px 16px;">
                                    <i class="fas fa-paper-plane"></i> Post Comment
                                </button>
                            </form>
                        </div>
                    {% else %}
                        <div style="margin-bottom: 20px; padding: 16px; background: var(--gray-100); border-radius: 8px; text-align: center;">
                            <p style="margin-bottom: 8px; color: var(--text-secondary);">Want to comment on this recommendation?</p>
                            <a href="{{ url_for('login') }}" class="btn btn-primary" style="font-size: 12px;">
                                <i class="fas fa-sign-in-alt"></i> Login to Comment
                            </a>
                        </div>
                    {% endif %}
                    
                    <!-- Comments List -->
                    {% if recommendation.comments %}
                        <div style="space-y: 12px;">
                            {% for comment in recommendation.comments %}
                                <div class="window" style="margin-bottom: 12px;">
                                    <div class="window-header" style="font-size: 11px;">
                                        <span>
                                            <i class="fas fa-user"></i> 
                                            {{ comment.user.profile.name if comment.user.profile else comment.user.username }}
                                        </span>
                                        <div style="font-size: 10px; color: var(--text-secondary);">
                                            {{ comment.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                                            {% if current_user and (comment.user_id == current_user.id or recommendation.category.profile.user_id == current_user.id) %}
                                                <form method="POST" action="{{ url_for('delete_comment', profile_slug=profile.slug, category_slug=category.slug, rec_id=recommendation.id, comment_id=comment.id) }}" 
                                                      style="display: inline; margin-left: 8px;" 
                                                      onsubmit="return confirm('Are you sure you want to delete this comment?')">
                                                    <button type="submit" style="background: none; border: none; color: var(--primary-orange); cursor: pointer; font-size: 10px;">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="window-content" style="padding: 12px;">
                                        <p style="line-height: 1.4; margin: 0;">{{ comment.content }}</p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            <i class="fas fa-comment-slash" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                            <p>No comments yet. Be the first to share your thoughts!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Footer Info -->
        <div style="border-top: 1px solid var(--gray-200); padding-top: 16px; margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 10px; color: var(--text-secondary);">
                <div>
                    <i class="fas fa-calendar"></i> Added {{ recommendation.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                </div>
                <div style="display: flex; gap: 12px;">
                    <a href="{{ url_for('view_category', profile_slug=profile.slug, category_slug=category.slug) }}" class="btn">
                        <i class="fas fa-arrow-left"></i> Back to {{ category.name }}
                    </a>
                    <a href="{{ url_for('view_profile', slug=profile.slug) }}" class="btn">
                        <i class="fas fa-user"></i> {{ profile.name }}'s Profile
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const likeForm = document.getElementById('like-form');
    const likeButton = document.getElementById('like-button');
    const likeCount = document.getElementById('like-count');
    
    if (likeForm && likeButton) {
        likeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Disable button during request
            likeButton.disabled = true;
            
            fetch(likeForm.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update like count
                    likeCount.textContent = data.like_count;
                    
                    // Update button appearance and text
                    if (data.is_liked) {
                        likeButton.style.background = 'var(--primary-pink)';
                        likeButton.style.color = 'white';
                        likeButton.style.borderColor = 'var(--primary-pink)';
                        likeButton.innerHTML = '<i class="fas fa-heart"></i> Unlike';
                    } else {
                        likeButton.style.background = 'var(--gray-100)';
                        likeButton.style.color = 'var(--text-secondary)';
                        likeButton.style.borderColor = 'var(--gray-200)';
                        likeButton.innerHTML = '<i class="fas fa-heart"></i> Like';
                    }
                    
                    // Reload page to update "Liked by" section
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Fallback to regular form submission
                likeForm.submit();
            })
            .finally(() => {
                likeButton.disabled = false;
            });
        });
    }
});
</script>
{% endblock %}